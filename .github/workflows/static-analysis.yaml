name: Static Analysis Pipeline

on:
  push:
    branches-ignore:
      - dev
permissions:
  contents: write
  security-events: write  # Ensure the action can upload SARIF results    

jobs:
  tflint:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Cache TFLint plugin directory
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ubuntu-latest-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.52.0

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint and generate SARIF report
        run: |
          tflint -f sarif --chdir=infra/ --recursive > tflint.sarif
        continue-on-error: true

      - name: Upload TFLint SARIF file as artifact
        uses: actions/upload-artifact@v3
        with:
          name: tflint-sarif
          path: tflint.sarif

  checkov:
    name: 'Checkov Policies'
    runs-on: ubuntu-latest
    needs: tflint

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run Checkov PRISMA Policies
        run: |
          checkov -d infra/ --output-format sarif --output-file checkov-results.sarif
        continue-on-error: true

      - name: Upload Checkov SARIF as artifact
        uses: actions/upload-artifact@v3
        with:
          name: checkov-sarif
          path: checkov-results.sarif

  tfsec:
    name: tfsec sarif report
    runs-on: ubuntu-latest
    needs: tflint

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run TFSec
        run: |
          tfsec --format sarif --out tfsec-results.sarif

      - name: Upload TFSec SARIF as artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfsec-sarif
          path: tfsec-results.sarif

  manual_approval:
    name: Manual Approval for SonarQube Upload
    runs-on: ubuntu-latest
    needs: [tfsec]
    steps:
      - name: Await Manual Approval
        run: echo "Please approve this step manually before proceeding with the upload to SonarQube."

  convert_sarif:
    name: Convert SARIF to SonarQube Format
    runs-on: ubuntu-latest
    needs: manual_approval
    steps:
      - name: Download TFLint SARIF artifact
        uses: actions/download-artifact@v3
        with:
          name: tflint-sarif
          path: .

      - name: Download Checkov SARIF artifact
        uses: actions/download-artifact@v3
        with:
          name: checkov-sarif
          path: .

      - name: Download TFSec SARIF artifact
        uses: actions/download-artifact@v3
        with:
          name: tfsec-sarif
          path: .

      - name: Checkout Code (for the Python script)
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Run the SARIF to SonarQube conversion script
        run: |
          python .github/sarifToSonar.py

  upload-to-sonarqube:
    name: "Upload Converted Results to SonarQube"
    runs-on: ubuntu-latest
    needs: convert_sarif
    steps:
      - name: Upload Checkov Results to SonarQube
        run: |
          curl -u "${{ secrets.SONAR_TOKEN }}:" \
            -X POST "http://sonarqube:9000/api/issues/index" \
            -F projectKey=techFriday \
            -F file=@checkov-sonarqube.json

      - name: Upload TFSec Results to SonarQube
        run: |
          curl -u "${{ secrets.SONAR_TOKEN }}:" \
            -X POST "http://sonarqube:9000/api/issues/index" \
            -F projectKey=techFriday \
            -F file=@tfsec-sonarqube.json

  sonarqube:
    name: "SonarQube Analysis"
    runs-on: self-hosted
    needs: tflint
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run SonarQube Analysis
        run: |
          sonar-scanner \
            -Dsonar.projectKey=techFriday \
            -Dsonar.sources=infra \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.token=sqp_37363d6fd7941be7da7e6fa9995ee04058c0c368 \
            -Dsonar.working.directory=/home/docker/.scannerwork
